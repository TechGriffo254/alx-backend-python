# Django MessagingApp - Render Deployment Guide

## Overview
This guide walks you through deploying your Django MessagingApp to Render with Celery workers, PostgreSQL database, Redis, and public Swagger documentation.

## Prerequisites
- GitHub account with your code pushed to a repository
- Render account (sign up at https://render.com)
- Gmail account for email notifications (or another SMTP service)

---

## Deployment Steps

### Step 1: Prepare Your Repository

1. **Ensure all files are committed to GitHub:**
   ```bash
   git add .
   git commit -m "Prepare for Render deployment"
   git push origin main
   ```

2. **Verify these files exist in your repository:**
   - `render.yaml` âœ“
   - `build.sh` âœ“
   - `requirements.txt` âœ“
   - `runtime.txt` âœ“
   - `Procfile` âœ“

---

### Step 2: Deploy to Render

#### Option A: Using render.yaml (Recommended)

1. Go to https://dashboard.render.com
2. Click **"New +"** â†’ **"Blueprint"**
3. Connect your GitHub repository
4. Render will automatically detect `render.yaml` and create:
   - PostgreSQL database
   - Redis instance
   - Web service (Django app)
   - Worker service (Celery)

#### Option B: Manual Setup

If the blueprint doesn't work, create services manually:

##### 2.1: Create PostgreSQL Database
1. Click **"New +"** â†’ **"PostgreSQL"**
2. Name: `messaging-app-db`
3. Plan: **Free**
4. Click **"Create Database"**
5. Save the **Internal Database URL** (you'll need this)

##### 2.2: Create Redis Instance
1. Click **"New +"** â†’ **"Redis"**
2. Name: `messaging-app-redis`
3. Plan: **Free**
4. Click **"Create Redis"**
5. Save the **Internal Redis URL**

##### 2.3: Create Web Service
1. Click **"New +"** â†’ **"Web Service"**
2. Connect your GitHub repository
3. Configure:
   - **Name:** `messaging-app-web`
   - **Runtime:** Python 3
   - **Build Command:** `./build.sh`
   - **Start Command:** `gunicorn messaging_app.wsgi:application --bind 0.0.0.0:$PORT --workers 3 --timeout 120`
   - **Plan:** Free

##### 2.4: Create Celery Worker
1. Click **"New +"** â†’ **"Background Worker"**
2. Connect your GitHub repository
3. Configure:
   - **Name:** `messaging-app-celery-worker`
   - **Runtime:** Python 3
   - **Build Command:** `pip install -r requirements.txt`
   - **Start Command:** `celery -A messaging_app worker --loglevel=info`
   - **Plan:** Free

---

### Step 3: Configure Environment Variables

For **both Web Service and Worker**, add these environment variables:

#### Required Environment Variables:

```bash
# Django Settings
SECRET_KEY=<auto-generated-by-render>
DEBUG=False
ALLOWED_HOSTS=<your-app-name>.onrender.com

# Database (from PostgreSQL service)
DB_ENGINE=django.db.backends.postgresql
DB_NAME=<from-database-service>
DB_USER=<from-database-service>
DB_PASSWORD=<from-database-service>
DB_HOST=<from-database-service>
DB_PORT=5432

# Celery Configuration
CELERY_BROKER_URL=redis://<redis-internal-url>
CELERY_RESULT_BACKEND=redis://<redis-internal-url>

# Email Configuration (Gmail example)
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password
DEFAULT_FROM_EMAIL=noreply@messagingapp.com

# CORS Settings
CORS_ALLOW_ALL_ORIGINS=False
CORS_ALLOWED_ORIGINS=https://<your-app-name>.onrender.com

# Security Settings
SECURE_SSL_REDIRECT=True
```

#### How to Add Environment Variables in Render:
1. Go to your service dashboard
2. Click **"Environment"** tab
3. Click **"Add Environment Variable"**
4. Enter key and value
5. Click **"Save Changes"**

---

### Step 4: Setup Gmail for Email Notifications

1. Go to your Google Account: https://myaccount.google.com/
2. Security â†’ 2-Step Verification (enable it)
3. Security â†’ App passwords
4. Generate an app password for "Mail"
5. Copy the 16-character password
6. Use this as `EMAIL_HOST_PASSWORD` in Render

---

### Step 5: Deploy and Verify

1. **Trigger Deployment:**
   - Render will automatically deploy when you push to GitHub
   - Or click **"Manual Deploy"** â†’ **"Deploy latest commit"**

2. **Monitor Deployment:**
   - Watch the build logs in Render dashboard
   - Ensure no errors during:
     - Dependencies installation
     - Database migrations
     - Static files collection

3. **Check Services Status:**
   - Web service: Should show "Live"
   - Worker service: Should show "Running"
   - Database: Should show "Available"
   - Redis: Should show "Available"

---

### Step 6: Access Your Application

#### Your Application URLs:
- **Main App:** `https://<your-app-name>.onrender.com`
- **Admin Panel:** `https://<your-app-name>.onrender.com/admin/`
- **Swagger Docs:** `https://<your-app-name>.onrender.com/swagger/`
- **ReDoc:** `https://<your-app-name>.onrender.com/redoc/`

---

### Step 7: Test Your Deployment

#### Test 1: Swagger Documentation
1. Visit: `https://<your-app-name>.onrender.com/swagger/`
2. You should see the API documentation interface
3. Verify all endpoints are listed

#### Test 2: User Registration
```bash
curl -X POST https://<your-app-name>.onrender.com/api/auth/register/ \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "TestPass123!",
    "first_name": "Test",
    "last_name": "User"
  }'
```

#### Test 3: Login and Get Token
```bash
curl -X POST https://<your-app-name>.onrender.com/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "TestPass123!"
  }'
```

#### Test 4: Verify Celery Email Notification
1. Create a conversation and send a message
2. Check your email for notification
3. If email arrives, Celery is working correctly

#### Test 5: Check Logs
- Go to Render dashboard
- Click on your web service
- Click "Logs" tab
- Look for:
  - `Celery worker is running`
  - `Database migration successful`
  - No error messages

---

## Troubleshooting

### Issue 1: Build Fails
**Solution:**
- Check `build.sh` has execute permissions
- Verify `requirements.txt` is complete
- Check logs for missing dependencies

### Issue 2: Database Connection Error
**Solution:**
- Verify all `DB_*` environment variables are set correctly
- Ensure PostgreSQL service is "Available"
- Check if database URL is the internal URL

### Issue 3: Celery Worker Not Running
**Solution:**
- Check worker logs in Render dashboard
- Verify `CELERY_BROKER_URL` and `CELERY_RESULT_BACKEND` are correct
- Ensure Redis service is running

### Issue 4: Swagger Not Accessible
**Solution:**
- Check if `/swagger/` is in your `urls.py`
- Verify `drf-yasg` is in `INSTALLED_APPS`
- Check if static files are served correctly

### Issue 5: Static Files Not Loading
**Solution:**
- Run: `python manage.py collectstatic --noinput`
- Verify `STATIC_ROOT` and `STATIC_URL` settings
- Check `whitenoise` is in `MIDDLEWARE`

### Issue 6: Email Notifications Not Sending
**Solution:**
- Verify Gmail app password is correct
- Check Celery worker logs for errors
- Test email settings locally first

---

## Important Notes

### Free Tier Limitations:
- Web service: Spins down after 15 minutes of inactivity (cold starts)
- Database: 1GB storage limit
- Redis: 25MB memory limit
- Worker: Limited to 512MB RAM

### Cold Starts:
- First request after inactivity may take 30-60 seconds
- Subsequent requests will be fast
- Keep app warm with a cron service (optional)

### Database Backups:
- Free tier doesn't include automatic backups
- Export data regularly: `python manage.py dumpdata > backup.json`

---

## Maintenance and Updates

### Deploy New Changes:
```bash
git add .
git commit -m "Your changes"
git push origin main
```
Render will auto-deploy the changes.

### Manual Migration:
If migrations don't run automatically:
1. Go to web service
2. Click "Shell" tab
3. Run: `python manage.py migrate`

### View Logs:
```bash
# From Render dashboard
Click service â†’ Logs tab

# Or use Render CLI
render logs -s <service-name>
```

### Scale Workers (Paid Plans):
```bash
# In Render dashboard
Service â†’ Settings â†’ Instance Count
```

---

## Security Checklist

- [ ] `DEBUG=False` in production
- [ ] Strong `SECRET_KEY` generated
- [ ] `ALLOWED_HOSTS` configured correctly
- [ ] SSL/HTTPS enabled (automatic on Render)
- [ ] Database credentials secured
- [ ] Email credentials use app passwords
- [ ] CORS properly configured
- [ ] Security middleware enabled

---

## Testing Checklist

- [ ] Swagger documentation accessible at `/swagger/`
- [ ] User registration working
- [ ] User login returning JWT tokens
- [ ] API endpoints responding correctly
- [ ] Celery tasks processing
- [ ] Email notifications sending
- [ ] Database queries working
- [ ] Static files loading
- [ ] Admin panel accessible

---

## Support and Resources

### Render Documentation:
- Django Deployment: https://render.com/docs/deploy-django
- Environment Variables: https://render.com/docs/environment-variables
- Background Workers: https://render.com/docs/background-workers

### Django Resources:
- Django Deployment Checklist: https://docs.djangoproject.com/en/5.0/howto/deployment/checklist/
- Celery Documentation: https://docs.celeryproject.org/

### Project Documentation:
- See `DEPLOYMENT.md` for general deployment info
- See `DEPLOYMENT_SUMMARY.md` for quick reference
- See `QUICKSTART.md` for local development

---

## Submission Checklist for Assignment

Before submitting your project, ensure:

1. **Deployment Complete:**
   - [ ] Application deployed to Render
   - [ ] All services running (web, worker, database, redis)
   - [ ] No errors in logs

2. **Swagger Documentation:**
   - [ ] Accessible at `https://your-app.onrender.com/swagger/`
   - [ ] All endpoints documented
   - [ ] Authentication working in Swagger UI

3. **Celery Working:**
   - [ ] Worker service running
   - [ ] Email notifications sending
   - [ ] Background tasks processing

4. **Testing Complete:**
   - [ ] User registration tested
   - [ ] Login and JWT authentication tested
   - [ ] CRUD operations on conversations tested
   - [ ] CRUD operations on messages tested
   - [ ] Email notifications tested

5. **URLs to Submit:**
   - Application URL: `https://your-app.onrender.com`
   - Swagger URL: `https://your-app.onrender.com/swagger/`
   - GitHub Repository: `https://github.com/yourusername/yourrepo`

---

## Quick Commands Reference

```bash
# Local testing
python manage.py runserver
celery -A messaging_app worker --loglevel=info

# Database operations
python manage.py makemigrations
python manage.py migrate
python manage.py createsuperuser

# Static files
python manage.py collectstatic --noinput

# Testing
python manage.py test

# Git deployment
git add .
git commit -m "Deploy to Render"
git push origin main
```

---

## Contact and Support

If you encounter issues:
1. Check the troubleshooting section above
2. Review Render logs for error messages
3. Check Django error logs
4. Review Celery worker logs
5. Consult Render documentation

Good luck with your deployment! ðŸš€
